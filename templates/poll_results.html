{% extends "base.html" %}

{% block title %}Результаты: {{ poll.title }} - PollHub{% endblock %}

{% block extra_css %}
<style>
    .results-card {
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
    }
    
    .result-item {
        transition: transform 0.3s;
        border-left: 4px solid;
        padding-left: 15px;
        margin-bottom: 1.5rem;
    }
    
    .result-item:hover {
        transform: translateX(5px);
    }
    
    .progress-container {
        height: 35px;
        border-radius: 8px;
        overflow: hidden;
        background: #f8f9fa;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        position: relative;
    }
    
    .progress-bar-animated {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        transform: scaleX(0);
        transform-origin: left center;
        animation: scaleRight 1.5s ease-out forwards;
        min-width: 0%;
        width: 100%;
    }
    
    @keyframes scaleRight {
        0% {
            transform: scaleX(0);
        }
        100% {
            transform: scaleX(calc(var(--target-width, 100) / 100));
        }
    }
    
    /* Цвета */
    .progress-1 { 
        background: linear-gradient(90deg, #2ecc71, #27ae60);
        animation-delay: 0.1s;
    }
    .progress-2 { 
        background: linear-gradient(90deg, #3498db, #2980b9);
        animation-delay: 0.3s;
    }
    .progress-3 { 
        background: linear-gradient(90deg, #f39c12, #d35400);
        animation-delay: 0.5s;
    }
    .progress-4 { 
        background: linear-gradient(90deg, #e74c3c, #c0392b);
        animation-delay: 0.7s;
    }
    
    .chart-container {
        height: 300px;
        position: relative;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }
    
    .chart-bar {
        width: 22%;
        margin: 0 1.5%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
    }
    
    .chart-bar-inner {
        width: 100%;
        border-radius: 6px 6px 0 0;
        transition: height 1.5s ease-in-out;
    }
    
    .option-color-1 { border-color: #2ecc71; }
    .option-color-2 { border-color: #3498db; }
    .option-color-3 { border-color: #f39c12; }
    .option-color-4 { border-color: #e74c3c; }
    
    .progress-1 { 
        background: linear-gradient(90deg, #2ecc71, #27ae60);
        border-color: #2ecc71;
    }
    .progress-2 { 
        background: linear-gradient(90deg, #3498db, #2980b9);
        border-color: #3498db;
    }
    .progress-3 { 
        background: linear-gradient(90deg, #f39c12, #d35400);
        border-color: #f39c12;
    }
    .progress-4 { 
        background: linear-gradient(90deg, #e74c3c, #c0392b);
        border-color: #e74c3c;
    }
    
    .stat-card {
        border-radius: 10px;
        transition: all 0.3s;
        height: 100%;
        margin-bottom: 1.5rem;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .stat-card .card-body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    /* Фикс для наложения */
    .row {
        margin-left: -15px;
        margin-right: -15px;
    }
    
    .col-md-3, .col-lg-8, .col-lg-4 {
        padding-left: 15px;
        padding-right: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <!-- Заголовок -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-primary mb-3">
                    <i class="bi bi-bar-chart me-3"></i>Результаты опроса
                </h1>
                <h2 class="h4 text-muted">{{ poll.title }}</h2>
                <p class="lead text-muted">{{ poll.question }}</p>
            </div>

            <!-- Статистические карточки -->
            <div class="row mb-4">
                <!-- Карточка 1: Всего голосов -->
                <div class="col-md-3 mb-3">
                    <div class="stat-card card border-primary text-center">
                        <div class="card-body">
                            <div class="display-4 fw-bold text-primary">
                                {{ total_votes|default(0) }}
                            </div>
                            <div class="text-muted mb-2">Всего голосов</div>
                            <i class="bi bi-people fs-1 text-primary"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Карточка 2: Среднее на вариант -->
                <div class="col-md-3 mb-3">
                    <div class="stat-card card border-success text-center">
                        <div class="card-body">
                            <div class="display-4 fw-bold text-success">
                                {{ avg_per_option|default(0)|round(1) }}
                            </div>
                            <div class="text-muted mb-2">Среднее на вариант</div>
                            <i class="bi bi-graph-up fs-1 text-success"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Карточка 3: Лидирующий вариант -->
                <div class="col-md-3 mb-3">
                    <div class="stat-card card border-warning text-center">
                        <div class="card-body">
                            <div class="display-4 fw-bold text-warning">
                                {{ leading_percentage|default(0)|round(1) }}%
                            </div>
                            <div class="text-muted mb-2">
                                Лидирует: 
                                {% if leading_option %}
                                    Вариант {{ leading_option }}
                                {% else %}
                                    Нет данных
                                {% endif %}
                            </div>
                            <i class="bi bi-trophy fs-1 text-warning"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Карточка 4: Дата создания -->
                <div class="col-md-3 mb-3">
                    <div class="stat-card card border-info text-center">
                        <div class="card-body">
                            <div class="display-4 fw-bold text-info">
                                {{ poll.created_at.strftime('%d.%m') if poll.created_at else '--.--' }}
                            </div>
                            <div class="text-muted mb-2">Дата создания</div>
                            <i class="bi bi-calendar-event fs-1 text-info"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Информация о голосе пользователя -->
            {% if user_vote %}
            <div class="alert alert-success mb-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill fs-3 me-3"></i>
                    <div class="flex-grow-1">
                        <h5 class="alert-heading mb-1">Ваш голос учтён!</h5>
                        <p class="mb-0">
                            Вы выбрали <strong>вариант {{ user_vote }}: "{{ option_texts[user_vote] }}"</strong>
                            <small class="d-block text-muted mt-1">
                                <i class="bi bi-laptop me-1"></i>IP-адрес: {{ user_ip }}
                            </small>
                        </p>
                    </div>
                    <div class="badge bg-success fs-6 p-2">
                        Выбор сделан
                    </div>
                </div>
            </div>
            {% elif total_votes > 0 %}
            <div class="alert alert-info mb-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-info-circle-fill fs-3 me-3"></i>
                    <div>
                        <h5 class="alert-heading mb-1">Вы ещё не голосовали</h5>
                        <p class="mb-0">
                            <a href="{{ url_for('poll_detail', poll_id=poll.id) }}" class="alert-link fw-bold">
                                Проголосовать сейчас
                            </a>
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Основные результаты -->
            <div class="card results-card">
                <div class="card-header bg-primary text-white py-3">
                    <h3 class="mb-0">
                        <i class="bi bi-pie-chart me-2"></i>Детальные результаты
                    </h3>
                </div>
                
                <div class="card-body">
                    {% if total_votes > 0 %}
                    <div class="row">
                        <div class="col-lg-8">
                            <h5 class="mb-4">Распределение голосов:</h5>
                            
                            {% for option_num in [1, 2, 3, 4] %}
                            <div class="result-item option-color-{{ option_num }}">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <strong class="fs-5">Вариант {{ option_num }}</strong>
                                        <div class="text-muted">{{ option_texts[option_num] }}</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fs-4 fw-bold">
                                            {{ vote_counts[option_num] }}
                                        </div>
                                        <div class="text-muted">
                                            {{ percentages[option_num] }}%
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="progress-container">
                                    <div class="progress-bar-animated progress-{{ option_num }}"
                                         style="width: {{ percentages[option_num] }}%">
                                        {{ percentages[option_num] }}%
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card border-light h-100">
                                <div class="card-body">
                                    <h5 class="mb-4">
                                        <i class="bi bi-calculator me-2"></i>Статистика
                                    </h5>
                                    
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span>Всего голосов:</span>
                                            <strong>{{ total_votes }}</strong>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span>Уникальных IP:</span>
                                            <strong>{{ total_votes }}</strong>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span>Лидирует:</span>
                                            <strong>Вариант {{ leading_option }} ({{ leading_percentage }}%)</strong>
                                        </div>
                                        <div class="list-group-item d-flex justify-content-between">
                                            <span>Активность:</span>
                                            <strong>
                                                {% if total_votes > 3 %}Высокая
                                                {% elif total_votes > 0 %}Средняя
                                                {% else %}Низкая{% endif %}
                                            </strong>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h6 class="text-muted mb-3">
                                            <i class="bi bi-shield-check me-2"></i>О голосовании
                                        </h6>
                                        <ul class="small text-muted mb-0 ps-3">
                                            <li>Один голос с одного IP-адреса</li>
                                            <li>Голосование анонимное</li>
                                            <li>Результаты обновляются в реальном времени</li>
                                            <li>Администрация проверяет честность голосования</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Диаграмма -->
                    <div class="mt-5 pt-4 border-top">
                        <h5 class="mb-4">
                            <i class="bi bi-graph-up me-2"></i>Визуализация результатов
                        </h5>
                        <div class="chart-container">
                            <div class="d-flex align-items-end h-100 justify-content-center">
                                {% for option_num in [1, 2, 3, 4] %}
                                <div class="chart-bar">
                                    <div class="chart-bar-inner progress-{{ option_num }} mb-2"
                                         style="height: {{ percentages[option_num] * 2 }}px;">
                                    </div>
                                    <div class="text-center">
                                        <div class="fw-bold fs-5">{{ vote_counts[option_num] }}</div>
                                        <small class="text-muted">Вар. {{ option_num }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    {% else %}
                    <!-- Нет голосов -->
                    <div class="text-center py-5">
                        <i class="bi bi-bar-chart fs-1 text-muted mb-3 d-block"></i>
                        <h4 class="text-muted mb-3">Пока нет голосов</h4>
                        <p class="text-muted mb-4">Будьте первым, кто проголосует в этом опросе!</p>
                        <a href="{{ url_for('poll_detail', poll_id=poll.id) }}" 
                           class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle me-2"></i>Проголосовать сейчас
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Навигация -->
            <div class="d-flex justify-content-between align-items-center mt-4 mb-5">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Все опросы
                </a>
                
                <div>
                    <a href="{{ url_for('poll_detail', poll_id=poll.id) }}" 
                       class="btn btn-outline-primary me-2">
                        <i class="bi bi-eye me-1"></i>Страница опроса
                    </a>
                    {% if user_vote %}
                    <button class="btn btn-success" disabled>
                        <i class="bi bi-check-circle me-1"></i>Вы проголосовали
                    </button>
                    {% else %}
                    <a href="{{ url_for('poll_detail', poll_id=poll.id) }}" 
                       class="btn btn-success">
                        <i class="bi bi-check-circle me-2"></i>Проголосовать
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Анимация при загрузке - исправленная версия
    document.addEventListener('DOMContentLoaded', function() {
        // Анимация прогресс-баров
        const progressBars = document.querySelectorAll('.progress-bar-animated');
        progressBars.forEach(function(bar) {
            // Сохраняем оригинальную ширину в data-атрибут
            const originalWidth = bar.style.width;
            bar.setAttribute('data-width', originalWidth);
            
            // Устанавливаем начальную ширину 0%
            bar.style.width = '0%';
            
            // Анимируем через небольшой таймаут
            setTimeout(function() {
                bar.style.width = originalWidth;
            }, 100);
        });
        
        // Анимация диаграммы
        const chartBars = document.querySelectorAll('.chart-bar-inner');
        chartBars.forEach(function(bar) {
            // Сохраняем оригинальную высоту
            const originalHeight = bar.style.height;
            bar.setAttribute('data-height', originalHeight);
            
            // Устанавливаем начальную высоту 0
            bar.style.height = '0px';
            
            // Анимируем
            setTimeout(function() {
                bar.style.height = originalHeight;
            }, 300);
        });
    });
</script>
{% endblock %}